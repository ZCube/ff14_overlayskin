<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
  		<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
        <style>
            /* GLOBAL */
            * {font-family:"맑은 고딕";}
            html, body {margin:0px; padding:0px;}

            /* TAB */
            body>.menu {position:fixed; left:8px; bottom:8px; right:8px; height:20px;}
            body>.menu>.tabs {position:absolute; min-width:0px; height:20px; border-radius:10px; padding:0px 20px 0px 20px; line-height:19px; font-size:12px; color:#EDDFC1; text-shadow:0px 1px 0px #000; background:linear-gradient(to bottom, #5C5C5C 0%, #4B4B4B 50%, #383838 50%, #404040 100%); box-shadow:inset 0px 1px 0px rgba(255,255,255,.3), 0px 1px 0px rgba(0,0,0,0.5); -webkit-filter:drop-shadow(0px 0px 2px #000);}
            body>.menu>.tabs:after, body>.menu>.tabs:before {position:absolute; top:0px; content:" "; box-sizing:border-box; width:20px; height:20px;}
            body>.menu>.tabs:after {left:0px; box-shadow:inset -1px 0px 0px rgba(255,255,255,.15); border-right:1px solid rgba(0,0,0,0.2);}
            body>.menu>.tabs:before {right:0px; box-shadow:inset 1px 0px 0px rgba(255,255,255,.15); border-left:1px solid rgba(0,0,0,0.2);}
            body>.menu>.tabs>.tab {padding:0px 11px 0px 11px; border:1px solid rgba(255,255,255,.15); border-width:0px 1px 0px 1px; height:20px; cursor:pointer; float:left;}
            body>.menu>.tabs>.tab:not(:first-child) {border-left:1px solid rgba(0,0,0,0.2); padding-left:12px; box-shadow:inset 1px 0px 0px rgba(255,255,255,.15);}
            body>.menu>.tabs>.tab:hover {background:linear-gradient(to bottom, rgba(255,255,255,.1) 0%, rgba(255,255,255,.05) 50%, rgba(255,255,255,.1) 100%);}

            /* DATA */
            body>.data {position:fixed; left:8px; top:8px; right:8px; bottom:42px;}
            body>.data:after {position:absolute; z-index:-1; left:1px; right:1px; top:1px; bottom:1px; content:" "; background:#000; -webkit-filter:blur(4px); opacity:.5;border-radius:8px;}
            body>.data>.cont {position:absolute; z-index:1; left:0px; right:0px; top:0px; bottom:0px; color:#FFF; font-size:12px; padding:8px;}
            body>.data>.cont>.encounter {padding:5px; color:#EDDFC1; text-shadow:0px 1px 0px #000; box-shadow:0px 0px 1px rgba(0,0,0,0.25);}
            body>.data>.cont>.encounter span {font-size:7px; display:inline-block; transform:scale(.8, .8); margin-left:10px;}
        </style>
    </head>
    <body>
        <div class="data">
            <div class="cont">
                <div class="encounter">[00:00] Encounter (--- DPS / --- HPS) <span>▼</span></div>
            </div>
        </div>
        <div class="menu">
            <!-- TAB CUSTOMIZE Find "function createTabs"-->
            <div class="tabs">
                <div class="tab">DPS</div>
                <div class="tab">HPS</div>
                <div class="tab">ACC&amp;CRIT</div>
            </div>
        </div>
    </body>
    <script>
        var wsUri = "ws://127.0.0.1:10501/MiniParse";
        // ACTWebSocket 적용
        function connectWebSocket(uri)
        {
            websocket = new WebSocket(uri);
            websocket.onmessage = function(evt)
            {
                if (evt.data == ".")
                {
                    // ping pong
                    websocket.send(".");
                }
                else
                {
                    try{
                        var obj = JSON.parse(evt.data);
                        var type = obj["type"];

                        if(type == "broadcast")
                        {
                            var from = obj["from"];
                            var type = obj["msgtype"];
                            var msg = obj["msg"];
                            document.dispatchEvent(new CustomEvent('onBroadcastMessage', { detail: obj }));
                        }

                        if(type == "send")
                        {
                            var from = obj["from"];
                            var type = obj["msgtype"];
                            var msg = obj["msg"];
                            document.dispatchEvent(new CustomEvent('onRecvMessage', { detail: obj }));
                        }

                        if(type == "set_id")
                        {
                            //document.dispatchEvent(new CustomEvent('onIdChanged', { detail: obj }));
                        }
                    }
                    catch(e)
                    {

                    }
                }
            };

            websocket.onclose = function(evt) 
            { 
                setTimeout(function(){connectWebSocket(uri)}, 2000);
            };

            websocket.onerror = function(evt) 
            {
                websocket.close();
            };
        }    

        $(document).ready(function() 
        {
            connectWebSocket(wsUri);
        });

        function broadcast(type, msg)
        {
            var obj = {};
            obj["type"] = "broadcast";
            obj["msgtype"] = type;
            obj["msg"] = msg;
            websocket.send(JSON.stringify(obj));
        };

        function send(to, type, msg)
        {
            var obj = {};
            obj["type"] = "send";
            obj["to"] = to;
            obj["msgtype"] = type;
            obj["msg"] = msg;
            websocket.send(JSON.stringify(obj));
        };

        function set_id(id)
        {
            var obj = {};
            obj["type"] = "set_id";
            obj["id"] = id;
            websocket.send(JSON.stringify(obj));
        };

        document.addEventListener('onBroadcastMessage', onBroadcastMessage);
        document.addEventListener('onRecvMessage', onRecvMessage);
        window.addEventListener('message', function (e) 
        {
            if (e.data.type === 'onBroadcastMessage') 
            {
                onBroadcastMessage(e.data);
            }
            if (e.data.type === 'onRecvMessage') 
            {
                onRecvMessage(e.data);
            }
        });

        function onRecvMessage(e)
        {

        }

        function onBroadcastMessage(e)
        {
            if(e.detail.msgtype == "CombatData")
            {
                document.dispatchEvent(new CustomEvent('onOverlayDataUpdate', { detail: e.detail.msg }));
            }
            else
            {
                console.log(e.detail);
                switch(e.detail.msgtype)
                {
                    case "SendCharName":
                        myID = e.detail.msg.charID;
                        myName = e.detail.msg.charName;
                        $("#myname").html(myName);
                        if (combatants[myID] !== undefined && combatants[myID] !== null)
                        {
                            var max = combatants[myID].max_hp;
                            myhpconvert(max, max);
                        }
                        break;
                    case "AddCombatant":
                        combatants[e.detail.msg.id] = e.detail.msg;
                        if (e.detail.msg.id == myID)
                        {
                            var max = combatants[e.detail.msg.id].max_hp;
                            myhpconvert(max, max);
                        }
                        break;
                    case "RemoveCombatant":
                        combatants[e.detail.msg.id] = null;
                        break;
                    case "AbilityUse":
                        if (e.detail.msg.id == myID)
                        {
                            var max = e.detail.msg.max_hp;
                            var cur = e.detail.msg.cur_hp;
                            myhpconvert(cur, max);
                        }
                        break;
                }
            }
        }

        setInterval(function(){
            // Battle Auto Recovery
            curhp = curhp + (maxhp / 100);
            myhpconvert(curhp, maxhp);
        }, 3000);

        function myhpconvert(cur, max)
        {
            var color = "rgb(0,224,0)";
            maxhp = max;
            curhp = cur;

            if (maxhp < curhp)
                curhp = maxhp;

            perc = (curhp / (maxhp * 1.0)).toFixed(2);
            if(perc > 0.75) color = "rgb(0,224,0)";
            else if(perc > 0.35 && perc <= 0.75) color = "rgb(255, 192, 0)";
            else color = "rgb(192, 0, 0)";

            $("#hpbar").css({"width":((320 * perc)+16)+"px", "fill":color});
        }

        var maxhp = 100;
        var curhp = 100;
        var myID = 0;
        var myName = "";
        var combatants = [];
    </script>
</html>
